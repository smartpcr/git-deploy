# Velero

This [Fabrikate](https://github.com/microsoft/fabrikate) definition generates the Kubernetes resource manifests for [Velero](https://github.com/heptio/velero).

## Usage

Add the following to your component.yaml:

```yaml
subcomponents:
  - name: "velero"
    source: "https://github.com/microsoft/fabrikate-definitions.git"
    path: "definitions/fabrikate-velero"
    method: "git"
```

### Setting Up Backups on Azure

You will need to apply the following configuration to Velero as part of a config file (where `velero` is the subcomponent):

```yaml
velero:
  config:
    credentials:
      useSecret: true
      secretContents:
        AZURE_SUBSCRIPTION_ID: <subscription id>
        AZURE_TENANT_ID: <tenant id>
        AZURE_CLIENT_ID: <client id>
        AZURE_CLIENT_SECRET: <client secret>
    configuration:
      provider: "azure"
      backupStorageLocation:
        name: "azure"
        bucket: <blob container name>
        config:
          resourceGroup: <azure resource group name>
          storageAccount: <azure storage account name>
```

### Setting Up Volume Snapshots on Azure

Setting up volume snapshots requires three additional step.

1. Since AKS stores managed disks in an autogenerated resource group, you will need to provide the name of that resource group to Velero. Run the following command to find the autogenerated resource group name:
`az group list --query '[].{ ResourceGroup: name, Location:location }'`

2. Populate the autogenerated name into a `AZURE_RESOURCE_GROUP` in your credentials configuration object. See YAML below.

3. You will need to add the `volumeSnapshotLocation` configuration object. For Azure, setting the API timeout is the only required configuration option.

```yaml
velero:
  config:
    credentials:
      useSecret: true
      secretContents:
        AZURE_SUBSCRIPTION_ID: <subscription id>
        AZURE_TENANT_ID: <tenant id>
        AZURE_CLIENT_ID: <client id>
        AZURE_CLIENT_SECRET: <client secret>
        AZURE_RESOURCE_GROUP: MC_<name of resource group>_<name of cluster>_<region>
    configuration:
      provider: "azure"
      backupStorageLocation:
        name: "azure"
        bucket: <blob container name>
        config:
          resourceGroup: <azure resource group name>
          storageAccount: <azure storage account name>
      volumeSnapshotLocation:
        name: "azure"
        config:
          apitimeout: "10m"
```

### Setting Up Schedules

To add an hourly scheduled backup for a specific namespace (for example prometheus), append the following to your velero.config.

```yaml
schedules:
  hourly-prometheus-backup:
    schedule: "0 * * * *"
    template:
      includedNamespaces:
      - "*"
      labelSelector:
        matchLabels:
          namespace: "prometheus"
      snapshotVolumes: true
      ttl: "720h0m0s"
```
